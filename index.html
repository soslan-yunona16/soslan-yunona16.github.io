<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Album AR</title>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.157.0/",
          "three/addons/renderers/CSS3DRenderer.js": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/renderers/CSS3DRenderer.js",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <style>
      body {
        margin: 0;
      }
      .container {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }
      #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px;
        font-size: 18px;
        background: #555;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: default;
        z-index: 10001; /* Higher z-index */
      }
      #hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 10000;
        text-align: center;
        font-family: sans-serif;
        font-size: 16px;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        gap: 10px;
        opacity: 1;
        transition: opacity 0.5s ease-out;
      }
      #hint.fade-out {
        opacity: 0;
      }
      #hint svg {
        width: 64px;
        height: 64px;
      }
    </style>
  </head>
  <body>
    <div class="container"></div>
    <div id="loader">Loading assets...</div>
    <div id="hint">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
        <path d="M15.5 1h-8A2.5 2.5 0 0 0 5 3.5v17A2.5 2.5 0 0 0 7.5 23h8a2.5 2.5 0 0 0 2.5-2.5v-17A2.5 2.5 0 0 0 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"/>
        <path d="M3 7V5h1V3.5A1.5 1.5 0 0 1 5.5 2H6V0H5.5A3.5 3.5 0 0 0 2 3.5V5H0v2h2v2H0v2h2v2H0v2h2v-2h1v-2H2V9h1V7H3z"/>
        <path d="M21 17v2h-1v1.5a1.5 1.5 0 0 1-1.5 1.5H18v2h.5a3.5 3.5 0 0 0 3.5-3.5V19h2v-2h-2v-2h2v-2h-2v2h-1z"/>
      </svg>
      <span>Наведите камеру на фотографию</span>
    </div>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      document.addEventListener("DOMContentLoaded", () => {
        const loaderUI = document.getElementById('loader');
        const hintUI = document.getElementById('hint');
        
        const startAR = async(videos) => {
          hintUI.style.display = 'flex';
          let hintIsVisible = true;

          const mindarThree = new MindARThree({
            container: document.querySelector(".container"),
            imageTargetSrc: "./targets.mind",
            maxTrack: 6
          });
          const { renderer, scene, camera } = mindarThree;

          const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
          scene.add(light);

          const clock = new THREE.Clock();
          const contentGroups = [];

          for (let i = 0; i < videos.length; i++) {
            const video = videos[i];
            const texture = new THREE.VideoTexture(video);
            const videoGeometry = new THREE.PlaneGeometry(1, 1);
            const videoMaterial = new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 0 });
            const videoPlane = new THREE.Mesh(videoGeometry, videoMaterial);

            const frameGeometry = new THREE.PlaneGeometry(1.1, 1.1);
            const frameMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.7, roughness: 0.3, transparent: true, opacity: 0 });
            const frameMesh = new THREE.Mesh(frameGeometry, frameMaterial);
            frameMesh.position.z = -0.01;

            const contentGroup = new THREE.Group();
            contentGroup.userData.state = 'HIDDEN';
            contentGroup.add(videoPlane);
            contentGroup.add(frameMesh);
            contentGroups.push(contentGroup);

            const anchor = mindarThree.addAnchor(i);
            anchor.group.add(contentGroup);
          }

          await mindarThree.start();

          renderer.setAnimationLoop(() => {
            const delta = clock.getDelta();
            const fadeSpeed = 2.0;

            if (hintIsVisible) {
              let markerFound = false;
              for (let i = 0; i < mindarThree.anchors.length; i++) {
                if (mindarThree.anchors[i].visible) {
                  markerFound = true;
                  break;
                }
              }
              if (markerFound) {
                hintUI.classList.add('fade-out');
                hintIsVisible = false;
              }
            }

            for (let i = 0; i < contentGroups.length; i++) {
              const group = contentGroups[i];
              const anchor = mindarThree.anchors[i];
              const video = videos[i];

              if (anchor.visible && group.userData.state !== 'VISIBLE' && group.userData.state !== 'FADING_IN') {
                group.userData.state = 'FADING_IN';
                if (video.paused) video.play();
              }

              if (!anchor.visible && group.userData.state !== 'HIDDEN' && group.userData.state !== 'FADING_OUT') {
                group.userData.state = 'FADING_OUT';
              }

              if (group.userData.state === 'FADING_IN') {
                group.children.forEach(child => child.material.opacity += fadeSpeed * delta);
                if (group.children[0].material.opacity >= 1.0) {
                  group.children.forEach(child => child.material.opacity = 1.0);
                  group.userData.state = 'VISIBLE';
                }
              } else if (group.userData.state === 'FADING_OUT') {
                group.children.forEach(child => child.material.opacity -= fadeSpeed * delta);
                if (group.children[0].material.opacity <= 0.0) {
                  group.children.forEach(child => child.material.opacity = 0.0);
                  group.userData.state = 'HIDDEN';
                  if (!video.paused) video.pause();
                }
              }
            }
            renderer.render(scene, camera);
          });
        };

        // --- Preloading Logic ---
        const videoPaths = [
          "assets/video1.mp4", "assets/video2.mp4", "assets/video3.mp4",
          "assets/video4.mp4", "assets/video5.mp4", "assets/video6.mp4"
        ];
        const videos = [];
        let loadedCount = 0;

        videoPaths.forEach((path, index) => {
          const video = document.createElement("video");
          video.src = path;
          video.muted = true;
          video.loop = true;
          video.playsInline = true;
          video.preload = 'auto';

          video.addEventListener('canplaythrough', () => {
            loadedCount++;
            loaderUI.textContent = `Loading (${loadedCount}/${videoPaths.length})...`;
            if (loadedCount === videoPaths.length) {
              loaderUI.textContent = 'Start AR';
              loaderUI.style.cursor = 'pointer';
              loaderUI.addEventListener('click', () => {
                loaderUI.style.display = 'none';
                startAR(videos);
              });
            }
          }, { once: true });

          videos.push(video);
          video.load();
        });
      });
    </script>
  </body>
</html>
