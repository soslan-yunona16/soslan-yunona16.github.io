<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Album AR</title>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.157.0/",
          "three/addons/renderers/CSS3DRenderer.js": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/renderers/CSS3DRenderer.js",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <style>
      body { margin: 0; font-family: sans-serif; }
      .container { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
      .ui-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10001;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      .ui-button {
        padding: 12px 25px;
        font-size: 18px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        min-width: 220px;
        text-align: center;
      }
      #loader {
        background: #555;
        cursor: default;
      }
      #start-options { display: none; }
      #sound-toggle {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        background: rgba(0,0,0,0.6);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #sound-toggle svg { width: 30px; height: 30px; }
      #hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 10000;
        text-align: center;
        font-family: sans-serif;
        font-size: 16px;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        gap: 10px;
        opacity: 1;
        transition: opacity 0.5s ease-out;
      }
      #hint.fade-out { opacity: 0; }
      #hint svg { width: 64px; height: 64px; }
    </style>
  </head>
  <body>
    <div class="container"></div>
    <div class="ui-overlay">
      <div id="loader" class="ui-button">Loading assets...</div>
      <div id="start-options">
        <button id="start-with-sound" class="ui-button">Запустить со звуком</button>
        <button id="start-without-sound" class="ui-button">Запустить без звука</button>
      </div>
    </div>
    <div id="sound-toggle"></div>
    <div id="hint">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M15.5 1h-8A2.5 2.5 0 0 0 5 3.5v17A2.5 2.5 0 0 0 7.5 23h8a2.5 2.5 0 0 0 2.5-2.5v-17A2.5 2.5 0 0 0 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"/><path d="M3 7V5h1V3.5A1.5 1.5 0 0 1 5.5 2H6V0H5.5A3.5 3.5 0 0 0 2 3.5V5H0v2h2v2H0v2h2v2H0v2h2v-2h1v-2H2V9h1V7H3z"/><path d="M21 17v2h-1v1.5a1.5 1.5 0 0 1-1.5 1.5H18v2h.5a3.5 3.5 0 0 0 3.5-3.5V19h2v-2h-2v-2h2v-2h-2v2h-1z"/></svg>
      <span>Наведите камеру на фотографию</span>
    </div>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      document.addEventListener("DOMContentLoaded", () => {
        const loaderUI = document.getElementById('loader');
        const startOptionsUI = document.getElementById('start-options');
        const startWithSoundBtn = document.getElementById('start-with-sound');
        const startWithoutSoundBtn = document.getElementById('start-without-sound');
        const soundToggleUI = document.getElementById('sound-toggle');
        const hintUI = document.getElementById('hint');

        const svgIcon = {
          sound_on: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`,
          sound_off: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9.01V10h.73L12 5.73V4z"/></svg>`
        };

        const startAR = async(videos, options) => {
          let isMuted = options.initialMute;
          let hintIsVisible = true;

          hintUI.style.display = 'flex';
          soundToggleUI.style.display = 'flex';
          
          const updateSoundIcon = () => {
            soundToggleUI.innerHTML = isMuted ? svgIcon.sound_off : svgIcon.sound_on;
          };
          updateSoundIcon();

          soundToggleUI.addEventListener('click', () => {
            isMuted = !isMuted;
            videos.forEach(v => v.muted = isMuted);
            updateSoundIcon();
          });

          const mindarThree = new MindARThree({
            container: document.querySelector(".container"),
            imageTargetSrc: "./targets.mind",
            maxTrack: 6,
            filterMinCF: 0.001,
            filterBeta: 10
          });
          const { renderer, scene, camera } = mindarThree;
          const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
          scene.add(light);
          const clock = new THREE.Clock();
          const contentGroups = [];

          for (let i = 0; i < videos.length; i++) {
            const video = videos[i];
            video.muted = isMuted;
            const texture = new THREE.VideoTexture(video);
            const videoPlane = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 0 }));
            const frameMesh = new THREE.Mesh(new THREE.PlaneGeometry(1.1, 1.1), new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.7, roughness: 0.3, transparent: true, opacity: 0 }));
            frameMesh.position.z = -0.01;
            const contentGroup = new THREE.Group();
            contentGroup.userData.state = 'HIDDEN';
            contentGroup.add(videoPlane, frameMesh);
            contentGroups.push(contentGroup);
            const anchor = mindarThree.addAnchor(i);
            anchor.group.add(contentGroup);
          }

          await mindarThree.start();

          renderer.setAnimationLoop(() => {
            const delta = clock.getDelta();
            const fadeSpeed = 2.0;

            if (hintIsVisible) {
              let markerFound = false;
              for (let i = 0; i < mindarThree.anchors.length; i++) {
                if (mindarThree.anchors[i].visible) {
                  markerFound = true;
                  break;
                }
              }
              if (markerFound) {
                hintUI.classList.add('fade-out');
                hintIsVisible = false;
              }
            }

            for (let i = 0; i < contentGroups.length; i++) {
              const group = contentGroups[i];
              const anchor = mindarThree.anchors[i];
              const video = videos[i];

              if (anchor.visible && group.userData.state !== 'VISIBLE' && group.userData.state !== 'FADING_IN') {
                group.userData.state = 'FADING_IN';
                if (video.paused) video.play();
              }

              if (!anchor.visible && group.userData.state !== 'HIDDEN' && group.userData.state !== 'FADING_OUT') {
                group.userData.state = 'FADING_OUT';
              }

              if (group.userData.state === 'FADING_IN') {
                group.children.forEach(child => child.material.opacity += fadeSpeed * delta);
                if (group.children[0].material.opacity >= 1.0) {
                  group.children.forEach(child => child.material.opacity = 1.0);
                  group.userData.state = 'VISIBLE';
                }
              } else if (group.userData.state === 'FADING_OUT') {
                group.children.forEach(child => child.material.opacity -= fadeSpeed * delta);
                if (group.children[0].material.opacity <= 0.0) {
                  group.children.forEach(child => child.material.opacity = 0.0);
                  group.userData.state = 'HIDDEN';
                  if (!video.paused) video.pause();
                }
              }
            }
            renderer.render(scene, camera);
          });
        };

        // --- Preloading Logic ---
        const videoPaths = ["assets/video1.mp4", "assets/video2.mp4", "assets/video3.mp4", "assets/video4.mp4", "assets/video5.mp4", "assets/video6.mp4"];
        const videos = [];
        let loadedCount = 0;

        videoPaths.forEach(path => {
          const video = document.createElement("video");
          video.src = path;
          video.loop = true;
          video.playsInline = true;
          video.preload = 'auto';

          video.addEventListener('canplaythrough', () => {
            loadedCount++;
            loaderUI.textContent = `Loading (${loadedCount}/${videoPaths.length})...`;
            if (loadedCount === videoPaths.length) {
              loaderUI.style.display = 'none';
              startOptionsUI.style.display = 'flex';
              startOptionsUI.style.flexDirection = 'column';
            }
          }, { once: true });

          videos.push(video);
          video.load();
        });

        startWithSoundBtn.addEventListener('click', () => {
          startOptionsUI.style.display = 'none';
          startAR(videos, { initialMute: false });
        });

        startWithoutSoundBtn.addEventListener('click', () => {
          startOptionsUI.style.display = 'none';
          startAR(videos, { initialMute: true });
        });
      });
    </script>
  </body>
</html>